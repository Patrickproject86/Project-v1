<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>常见传染病诊断</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
</head>
<body>
<div class="page-container">
    <header class="site-header">
        <div class="header-logo">
            <h1 class="site-title">常见传染病诊断&科普</h1>
        </div>
        <nav class="site-nav">
            <ul>
                <li><a href="index.html" class="nav-link"><i class="fas fa-home"></i> 首页</a></li>
                <li><a href="diagnosis.html" class="nav-link active"><i class="fas fa-stethoscope"></i> 诊断页面</a></li>
                <li><a href="popularize.html" class="nav-link"><i class="fas fa-book"></i> 科普页面</a></li>
            </ul>
        </nav>
    </header>
    <main class="site-main">
        <section class="diagnosis-container">
            <h2>常见传染病诊断</h2>
            <form id="diagnosis-form">
                <label for="fever">是否发热：</label>
                <select id="fever" name="fever" required>
                    <option value="">请选择</option>
                    <option value="yes">是</option>
                    <option value="no">否</option>
                </select>

                <label for="cough">是否咳嗽：</label>
                <select id="cough" name="cough" required>
                    <option value="">请选择</option>
                    <option value="yes">是</option>
                    <option value="no">否</option>
                </select>

                <label for="sore-throat">是否喉咙痛：</label>
                <select id="sore-throat" name="sore-throat" required>
                    <option value="">请选择</option>
                    <option value="yes">是</option>
                    <option value="no">否</option>
                </select>

                <label for="muscle-pain">是否肌肉酸痛：</label>
                <select id="muscle-pain" name="muscle-pain" required>
                    <option value="">请选择</option>
                    <option value="yes">是</option>
                    <option value="no">否</option>
                </select>

                <label for="fatigue">是否疲劳：</label>
                <select id="fatigue" name="fatigue" required>
                    <option value="">请选择</option>
                    <option value="yes">是</option>
                    <option value="no">否</option>
                </select>

                <label for="runny-nose">是否流鼻涕：</label>
                <select id="runny-nose" name="runny-nose" required>
                    <option value="">请选择</option>
                    <option value="yes">是</option>
                    <option value="no">否</option>
                </select>

                <label for="diarrhea">是否腹泻：</label>
                <select id="diarrhea" name="diarrhea" required>
                    <option value="">请选择</option>
                    <option value="yes">是</option>
                    <option value="no">否</option>
                </select>

                <label for="vomiting">是否呕吐：</label>
                <select id="vomiting" name="vomiting" required>
                    <option value="">请选择</option>
                    <option value="yes">是</option>
                    <option value="no">否</option>
                </select>

                <label for="headache">是否头痛：</label>
                <select id="headache" name="headache" required>
                    <option value="">请选择</option>
                    <option value="yes">是</option>
                    <option value="no">否</option>
                </select>

                <label for="joint-pain">是否关节痛：</label>
                <select id="joint-pain" name="joint-pain" required>
                    <option value="">请选择</option>
                    <option value="yes">是</option>
                    <option value="no">否</option>
                </select>

                <label for="rash">是否皮疹：</label>
                <select id="rash" name="rash" required>
                    <option value="">请选择</option>
                    <option value="yes">是</option>
                    <option value="no">否</option>
                </select>

                <button type="submit">获取诊断</button>
            </form>
            <p id="result" style="margin-top: 20px; font-weight: bold; color: #333;"></p>
        </section>

        <!-- 诊断记录展示区域 -->
        <section class="diagnosis-records">
            <h2>最近诊断记录</h2>
            <div id="diagnosis-list">
                <p>正在加载诊断记录...</p>
            </div>
        </section>
    </main>
    <!-- <footer class="site-footer">
        <a href="feedback.html" class="feedback-link">用户反馈 <i class="fas fa-comments"></i></a>
    </footer> -->
</div>

<script>
    // 加载诊断记录
    async function loadDiagnosisRecords() {
        try {
            const response = await fetch('/api/diagnosis');
            if (response.ok) {
                const records = await response.json();
                displayDiagnosisRecords(records);
            } else {
                document.getElementById('diagnosis-list').innerHTML = '<p class="no-diagnosis">加载诊断记录失败</p>';
            }
        } catch (error) {
            console.error('加载诊断记录失败:', error);
            document.getElementById('diagnosis-list').innerHTML = '<p class="no-diagnosis">网络错误，无法加载诊断记录</p>';
        }
    }

    // 显示诊断记录
    function displayDiagnosisRecords(records) {
        console.log('开始显示诊断记录:', records);
        const diagnosisList = document.getElementById('diagnosis-list');
        
        if (!diagnosisList) {
            console.error('找不到 diagnosis-list 元素');
            return;
        }
        
        if (!records || records.length === 0) {
            diagnosisList.innerHTML = '<p class="no-diagnosis">暂无诊断记录</p>';
            return;
        }

        const recordsHTML = records.map(record => {
            try {
                console.log('处理记录:', record);
                // 直接使用record.symptoms，因为从API返回的已经是对象
                const symptoms = record.symptoms;
                const positiveSymptoms = Object.entries(symptoms)
                    .filter(([key, value]) => value === 'yes')
                    .map(([key, value]) => getSymptomName(key));

                console.log('正面症状:', positiveSymptoms);

                return `
                    <div class="diagnosis-item">
                        <div class="diagnosis-header">
                            <span class="diagnosis-date">${new Date(record.created_at).toLocaleString('zh-CN')}</span>
                        </div>
                        <div class="diagnosis-result">${record.result}</div>
                        <div class="diagnosis-symptoms">
                            <strong>症状：</strong>
                            <div class="symptoms-list">
                                ${positiveSymptoms.length > 0 
                                    ? positiveSymptoms.map(symptom => `<span class="symptom-tag">${symptom}</span>`).join('') 
                                    : '<span class="no-symptoms">无症状记录</span>'
                                }
                            </div>
                        </div>
                    </div>
                `;
            } catch (err) {
                console.error('解析记录失败:', err, record);
                return `
                    <div class="diagnosis-item">
                        <div class="diagnosis-header">
                            <span class="diagnosis-date">${new Date(record.created_at).toLocaleString('zh-CN')}</span>
                        </div>
                        <div class="diagnosis-result">数据解析错误: ${err.message}</div>
                    </div>
                `;
            }
        }).join('');

        console.log('生成的HTML:', recordsHTML);
        diagnosisList.innerHTML = recordsHTML;
        console.log('HTML已设置到页面');
    }

    // 症状名称映射
    function getSymptomName(symptomKey) {
        const symptomNames = {
            'fever': '发热',
            'cough': '咳嗽',
            'sore-throat': '喉咙痛',
            'muscle-pain': '肌肉酸痛',
            'fatigue': '疲劳',
            'runny-nose': '流鼻涕',
            'diarrhea': '腹泻',
            'vomiting': '呕吐',
            'headache': '头痛',
            'joint-pain': '关节痛',
            'rash': '皮疹'
        };
        return symptomNames[symptomKey] || symptomKey;
    }

    // 诊断函数
    function diagnose(symptoms) {
        // 定义疾病模式及其症状权重
        const diseasePatterns = [
            { disease: "甲型流感", symptoms: { fever: 1, cough: 1, 'sore-throat': 1, 'muscle-pain': 1 }, weight: 0.8 },
            { disease: "乙型流感", symptoms: { fever: 1, cough: 1, 'muscle-pain': 1 }, weight: 0.75 },
            { disease: "普通感冒", symptoms: { fever: 0.5, cough: 1, 'runny-nose': 1, fatigue: 1 }, weight: 0.7 },
            { disease: "诺如病毒感染", symptoms: { fever: 0.5, diarrhea: 1, vomiting: 1 }, weight: 0.85 },
            { disease: "呼吸道合胞病毒", symptoms: { fever: 1, cough: 1, 'runny-nose': 1 }, weight: 0.7 },
            { disease: "登革热", symptoms: { fever: 1, headache: 1, 'joint-pain': 1, rash: 1 }, weight: 0.9 },
            { disease: "疟疾", symptoms: { fever: 1, headache: 1, 'muscle-pain': 1 }, weight: 0.8 },
            { disease: "新冠感染", symptoms: { fever: 1, cough: 1, fatigue: 1, headache: 1 }, weight: 0.85 }
        ];

        let maxScore = 0;
        let diagnosedDisease = "未明确诊断";

        // 计算每种疾病的匹配分数
        for (const pattern of diseasePatterns) {
            let score = 0;
            let totalWeight = 0;

            for (const symptom in pattern.symptoms) {
                if (symptoms[symptom] === "yes") {
                    score += pattern.symptoms[symptom];
                }
                totalWeight += pattern.symptoms[symptom];
            }

            const matchScore = score / totalWeight * pattern.weight;

            if (matchScore > maxScore) {
                maxScore = matchScore;
                diagnosedDisease = pattern.disease;
            }
        }

        if (maxScore > 0.7) {
            return `根据您的症状，最可能的诊断是${diagnosedDisease}。建议尽快就医以进行进一步检查和确诊。`;
        } else if (maxScore > 0.5) {
            return `您的症状与${diagnosedDisease}有一定关联，但不确定。建议您咨询医生以获取专业意见。`;
        } else {
            return "您的症状不典型，可能是普通感冒或其他疾病。建议咨询医生。";
        }
    }

    // 修改现有的表单提交事件，添加重新加载记录的功能
    document.getElementById('diagnosis-form').addEventListener('submit', async function(event) {
        event.preventDefault();

        const symptoms = {
            fever: document.getElementById('fever').value,
            cough: document.getElementById('cough').value,
            'sore-throat': document.getElementById('sore-throat').value,
            'muscle-pain': document.getElementById('muscle-pain').value,
            fatigue: document.getElementById('fatigue').value,
            'runny-nose': document.getElementById('runny-nose').value,
            diarrhea: document.getElementById('diarrhea').value,
            vomiting: document.getElementById('vomiting').value,
            headache: document.getElementById('headache').value,
            'joint-pain': document.getElementById('joint-pain').value,
            rash: document.getElementById('rash').value
        };

        const result = diagnose(symptoms);
        document.getElementById('result').innerText = result;

        // 保存到数据库
        try {
            const response = await fetch('/api/diagnosis', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    symptoms: symptoms,
                    result: result
                })
            });

            if (response.ok) {
                console.log('诊断结果已保存到数据库');
                // 重新加载诊断记录
                loadDiagnosisRecords();
            }
        } catch (error) {
            console.error('保存诊断结果失败:', error);
        }
    });

    // 页面加载时获取诊断记录
    document.addEventListener('DOMContentLoaded', loadDiagnosisRecords);
</script>
</body>
</html>
